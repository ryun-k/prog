<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="qnaBoard">
	
	<!-- 검색 결과반영 동적 SQL -->
	<sql id="searchField">
		<if test="target eq 'title'">
			q_title like '%'||#{word}||'%'
		</if>
		<if test="target eq 'body'">
			q_content like '%'||#{word}||'%'
		</if>
		<if test="target eq 'writer'">
			q_id like '%'||#{word}||'%'
		</if>
		<if test="target eq 'both'">
			(q_title like '%'||#{word}||'%' or q_content like '%'||#{word}||'%')
		</if>
	</sql>
	
	<!-- 게시물 카운트 -->
	<select id="totalCount" resultType="int">
		select count(*) as cnt from qna
	</select>
	
	<!-- 목록보기 -->
	<select id="qnaList" parameterType="qVO" resultType="qVO">
		select * from
		(select rownum as rNo, q_no as no, q_title as title, m.m_id as id, q_wDate as wDate, q_hit as hit,depth from qna q, member m
		where m.m_id=q.q_id
		order by ref desc, step asc)
		where rNo BETWEEN #{start} and #{end}
	</select>
	
	<!-- 질문입력 쿼리 -->
	
	<insert id="insertQ" parameterType="qVO">
		insert into qna(q_no, q_title, q_content, q_id, q_wdate, q_hit, ref, step, depth, p_no) 
		values((select nvl(max(q_no),0)+1 from qna),#{title},#{content},#{id},sysdate,0,(select nvl(max(q_no),0)+1 from qna),1,0,null)
	</insert>
	
	<!-- 조회수 증가  -->	
	<update id="updateHit" parameterType="int">
		update qna set q_hit = q_hit+1 where q_no= #{oriNo}
	</update>
	
	<!-- 상세보기 -->
	<resultMap type="qVO" id="clobView">
		<result property="content" column="q_content" jdbcType="CLOB" javaType="java.lang.String"/>
	</resultMap>
	<select id="qnaView" resultMap="clobView" parameterType="int">
		select q_no as no, q_title as title, q_content, m.m_id as id, q_wDate as wDate, q_hit as hit, ref, step, depth
		from qna q, member m
		where q_no=#{no} and q.q_id = m.m_id
	</select>
	
	<!-- 답변입력 쿼리 -->
	<insert id="insertA" parameterType="qVO">
		INSERT INTO QNA(q_no, q_title, q_content, q_id, q_wdate, q_hit, ref, step, depth, p_no) 
		VALUES ((select nvl(max(q_no),0)+1 from qna), #{title}, #{content},#{id},sysdate,0,#{ref}, #{step}, #{depth},#{pNo})
	</insert>
	
	<!-- 스텝증가 -->	
	<update id="updateStep" parameterType="int">
		update qna set step = step+1 where ref= #{ref} and step >=#{step}
	</update>
	
	<!-- 수정하기 -->
	<update id="updateQna"  parameterType="qVO">
		update qna set q_title =#{title}, q_content=#{content}, q_id=#{id}
		WHERE q_no=#{oriNo}
	</update>
	
	<!-- 삭제하기 -->
	<delete id="deleteQna" parameterType="int">
		delete from qna where q_no=#{no}	
	</delete>
	
	<!-- 검색결과 카운트 -->
	<select id="searchCount" parameterType="qVO" resultType="int">
		select count(*) as cnt from qna where <include refid="searchField" />
	</select>
	
	<!-- 검색하기 -->
	<select id="searchList" parameterType="qVO" resultType="qVO">
		select * from
		(select rownum as rNo, q_no as no, q_title as title, m.m_id as id, q_wDate as wDate, q_hit as hit,depth from qna q, member m
		where m.m_id=q.q_id
		and 
		<include refid="searchField" />
		order by ref desc, step asc)
		where rNo BETWEEN #{start} and #{end}
	</select>
	
	
</mapper>
